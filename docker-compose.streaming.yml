version: '3.8'

# ============================================================================
# STREAMING ARCHITECTURE: NIFI → CONFLUENT CLOUD → SPARK → POSTGRESQL
# ============================================================================
# 
# Architecture:
#   Apache NiFi (Producer) → Confluent Cloud Kafka → Spark Consumer → PostgreSQL
#
# Services:
#   - NiFi: Visual data flow for ingesting Football-Data.org API to Kafka
#   - PostgreSQL: Stores streaming.live_events table
#   - Superset: Business Intelligence Dashboard
#
# Note: For local installation (recommended), see LOCAL_SETUP.md
#
# Access URLs:
#   - NiFi Web UI: https://localhost:8443/nifi
#     Username: admin
#     Password: adminadmin123456
#
# Note: Kafka/Zookeeper not needed (using Confluent Cloud managed service)
# ============================================================================

services:
  # ============================================================================
  # APACHE NIFI - Visual Producer for API → Kafka
  # ============================================================================
  nifi:
    image: apache/nifi:1.25.0
    container_name: football-nifi
    hostname: nifi
    ports:
      - "8443:8443"   # HTTPS Web UI
      - "8080:8080"   # HTTP (if HTTPS disabled)
      - "10000:10000" # Site-to-Site
    environment:
      # Single User Authentication
      SINGLE_USER_CREDENTIALS_USERNAME: admin
      SINGLE_USER_CREDENTIALS_PASSWORD: adminadmin123456
      # JVM Settings (adjust based on your RAM)
      NIFI_JVM_HEAP_INIT: 2g
      NIFI_JVM_HEAP_MAX: 4g
      # Web Properties
      NIFI_WEB_HTTPS_PORT: 8443
      NIFI_WEB_HTTPS_HOST: 0.0.0.0
      NIFI_WEB_PROXY_HOST: localhost:8443
    volumes:
      # Persistent storage for flows and data
      - nifi_conf:/opt/nifi/nifi-current/conf
      - nifi_database:/opt/nifi/nifi-current/database_repository
      - nifi_flowfile:/opt/nifi/nifi-current/flowfile_repository
      - nifi_content:/opt/nifi/nifi-current/content_repository
      - nifi_provenance:/opt/nifi/nifi-current/provenance_repository
      - nifi_state:/opt/nifi/nifi-current/state
      - nifi_logs:/opt/nifi/nifi-current/logs
      # Custom processors (optional)
      - ./nifi/extensions:/opt/nifi/nifi-current/extensions:ro
    networks:
      - football-streaming
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8443/nifi"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # NiFi takes ~2 minutes to start
    restart: unless-stopped
  # ============================================================================
  # Zookeeper - Required for LOCAL Kafka only (OPTIONAL with Confluent Cloud)
  # ============================================================================
  # zookeeper:
  #   image: confluentinc/cp-zookeeper:7.5.0
  #   container_name: football-zookeeper
  #   environment:
  #     ZOOKEEPER_CLIENT_PORT: 2181
  #     ZOOKEEPER_TICK_TIME: 2000
  #   ports:
  #     - "2181:2181"
  #   volumes:
  #     - zookeeper-data:/var/lib/zookeeper/data
  #     - zookeeper-logs:/var/lib/zookeeper/log
  #   networks:
  #     - football-streaming

  # ============================================================================
  # Kafka Broker - LOCAL only (OPTIONAL with Confluent Cloud)
  # ============================================================================
  # kafka:
  #   image: confluentinc/cp-kafka:7.5.0
  #   container_name: football-kafka
  #   depends_on:
  #     - zookeeper
  #   ports:
  #     - "9092:9092"
  #     - "29092:29092"
  #   environment:
  #     KAFKA_BROKER_ID: 1
  #     KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  #     KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
  #     KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
  #     KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
  #     KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
  #     KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
  #     KAFKA_LOG_RETENTION_HOURS: 24
  #     KAFKA_LOG_RETENTION_BYTES: 1073741824
  #   volumes:
  #     - kafka-data:/var/lib/kafka/data
  #   networks:
  #     - football-streaming
  #   healthcheck:
  #     test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
  #     interval: 10s
  #     timeout: 10s
  #     retries: 5

  # ============================================================================
  # Kafka UI - Web interface for LOCAL Kafka (OPTIONAL with Confluent Cloud)
  # ============================================================================
  # kafka-ui:
  #   image: provectuslabs/kafka-ui:latest
  #   container_name: football-kafka-ui
  #   depends_on:
  #     - kafka
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     KAFKA_CLUSTERS_0_NAME: football-cluster
  #     KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
  #     KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
  #   networks:
  #     - football-streaming

  # ============================================================================
  # PostgreSQL - For streaming data storage
  # ============================================================================
  postgres:
    image: postgres:14-alpine
    container_name: football-postgres
    environment:
      POSTGRES_DB: football_analytics
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 9281746356
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./schema/streaming_schema.sql:/docker-entrypoint-initdb.d/streaming_schema.sql
    networks:
      - football-streaming
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Apache Superset - Business Intelligence Dashboard
  # Note: For local installation (recommended), see LOCAL_SETUP.md
  # ============================================================================
  superset:
    image: apache/superset:3.0.0
    container_name: football-superset
    hostname: superset
    ports:
      - "8088:8088"
    environment:
      # Admin credentials
      SUPERSET_SECRET_KEY: thisISaSECRET_1234
      # Database connection
      SUPERSET_LOAD_EXAMPLES: "no"
      # PostgreSQL connection for metadata
      DATABASE_DIALECT: postgresql
      DATABASE_USER: postgres
      DATABASE_PASSWORD: 9281746356
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_DB: football_analytics
    volumes:
      - superset_home:/app/superset_home
      - ./superset/dashboards:/app/dashboards:ro
    networks:
      - football-streaming
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    command: >
      bash -c "
        superset db upgrade &&
        superset fab create-admin --username admin --firstname Admin --lastname User --email admin@superset.com --password admin &&
        superset init &&
        superset run -h 0.0.0.0 -p 8088 --with-threads --reload --debugger
      "

# ============================================================================
# Volumes
# ============================================================================
volumes:
  # NiFi persistent volumes
  nifi_conf:
    driver: local
  nifi_database:
    driver: local
  nifi_flowfile:
    driver: local
  nifi_content:
    driver: local
  nifi_provenance:
    driver: local
  nifi_state:
    driver: local
  nifi_logs:
    driver: local
  # Database volumes
  postgres-data:
    driver: local
  # Superset volumes
  superset_home:
    driver: local
  # Legacy volumes (for local Kafka if needed)
  zookeeper-data:
    driver: local
  zookeeper-logs:
    driver: local
  kafka-data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  football-streaming:
    driver: bridge
    name: football-streaming-network
